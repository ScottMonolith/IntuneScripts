function Get-MultipleRegistryKeys { 
    [CmdletBinding()]
    param (
        [Parameter(Mandatory = $true)]
        [array]$RegistrySettings
    )

    foreach ($setting in $RegistrySettings) {
        $RegistryPath = $setting.RegistryPath
        $KeyName = $setting.KeyName
        $ValueData = $setting.ValueData
        try {
            $null = Get-ItemProperty -Path "$RegistryPath" -Name $KeyName -ErrorAction Stop
        }
        catch {
            Write-Host "Key '$RegistryPath\$KeyName' could not be found."
            exit 1
        }
        # Check if the registry key has the correct setting
        if ($ValueData -ne (Get-ItemPropertyValue -Path "$RegistryPath" -Name $KeyName)) {
            # Return false if the registry key doesn't exist
            Write-Host "Key '$RegistryPath\$KeyName' doesn't have the correct setting."
            exit 1
        }
        else {
            Write-Host "Key '$RegistryPath\$KeyName' good to go"
            continue
        }
    }
    exit 0
}

$vCores = Get-WmiObject Win32_Processor | Measure -Property  NumberOfCores -Sum
$vCores = $vCores.Sum
$vLogicalCPUs = Get-WmiObject Win32_Processor | Measure -Property  NumberOfLogicalProcessors -Sum
$vLogicalCPUs = $vLogicalCPUs.sum
$HT = @()
if ($vLogicalCPUs -gt $vCores) { 
    Write-Host "Hyper Threading Enabled"
    $HT = 1
}
else {  
    Write-Host "Hyper Threading Disabled"
    $HT = 0
}

# Define an array of registry settings to set
if ($HT -eq 1) {
    $registrySettings = @(
    @{
        RegistryPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management"
        KeyName = "FeatureSettingsOverride"
        ValueType = "DWord"
        ValueData = 8388680
    },
    @{
        RegistryPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management"
        KeyName = "FeatureSettingsOverrideMask"
        ValueType = "DWord"
        ValueData = 3
    }
    )
}
elseif ($HT -eq 0) {
    $registrySettings = @(
    @{
        RegistryPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management"
        KeyName = "FeatureSettingsOverride"
        ValueType = "DWord"
        ValueData = 8396872
    },
    @{
        RegistryPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management"
        KeyName = "FeatureSettingsOverrideMask"
        ValueType = "DWord"
        ValueData = 3
    }
    )
}
else {
    Write-Error "Hyper-threading status could not be determined..."
}

# Call the function to set the registry settings
Get-MultipleRegistryKeys -RegistrySettings $registrySettings
